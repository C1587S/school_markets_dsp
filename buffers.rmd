## Notebook for computing buffers

```{r, include=FALSE}
source('utils.R')
library(leaflet)
library(mapview)
library(htmltools)
```

#### Load the data
```{r}
db <- readRDS("./data/master_db_filtered.rds")
```

#### Preparing the data for computing buffers
```{r}
db <- sample_n(db, 4000)
db$latitud <- as.numeric(db$latitud)
db$longitud <- as.numeric(db$longitud)
```

#### Function for generating buffers
```{r}
# call our function for calculating buffers
buff_test <- calc_buffers(db, 5000, save=T)
# extract relevant elements
df_buffers <- buff_test$df_buffers
proj_buffers <- buff_test$buffers_proj
```

# convert buffers with one and two schools in polygons
```{r}

```


#### Calculate convex hulls
```{r}
ch_df <- calc_convexhulls(df_buffers, buffsize="5")
```

## Unions first attempt
```{r}
unions <- st_union(ch_df$ch_polygons) %>% st_collection_extract("POLYGON") %>%  st_sf()
unions
union_ch <- st_union(ch_df$ch_polygons) %>% st_collection_extract("POLYGON")  %>%  st_sf()
  
  
leaflet() %>%
    addTiles() %>% 
    addPolygons(data=unions, weight = 3, fillColor = "green", group = "Buffers")
```


#### Visualizing buffers in maps
```{r}
# map
map_buffers_v2(proj_buffers, df_buffers)
```

#### Big map with layers
```{r}

  leaflet() %>%
  # Schools
    addTiles() %>% 
    addMarkers(data=df_buffers, ~longitud, ~latitud,group = "Schools",
                     clusterOptions = markerClusterOptions(),
                     label = ~htmlEscape(paste("CCT:", cct, "Buffer", buffer)),
                icon = list(
                iconUrl = './data/school_icon.png',
                 iconSize = c(75, 75))) %>% 
  # convexhulls
  addPolygons(data=ch_df$ch_polygons, group = "Convex Hulls",
              stroke = FALSE, smoothFactor = 0.2, fillOpacity = 0.2, fillColor="red") %>% 
  # Buffers
  addPolygons(data=proj_buffers, weight = 3, fillColor = "green", group = "Buffers") %>%
  # Unions
  addPolygons(data=unions, weight = 3, fillColor = "yellow", group = "Convex Hull Unions") %>% 

  # Additionals
    # Layers control
    addLayersControl(
    # baseGroups = c("OSM (default)", "Toner", "Toner Lite"),
    overlayGroups = c("Schools", "Buffers", "Convex Hulls", "Convex Hull Unions"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  clearBounds()
```

