---
title: "network_visualization"
output: html_document
---

```{r}
source('utils.R')
library(tidyverse)
library(tidygraph)
library(ggraph)
library(igraphdata)
```

#### Load the data
```{r}
db <- readRDS("./data/master_db_filtered.rds")
```


#### Preparing the data for computing buffers
```{r}
set.seed(1992)
db <- sample_n(db, 15000)
db$latitud <- as.numeric(db$latitud)
db$longitud <- as.numeric(db$longitud)
```

#### Function for generating buffers
```{r}
# call our function for calculating buffers
buff_test <- calc_buffers(db, 3000)
# extract relevant elements
df_buffers <- buff_test$df_buffers
proj_buffers <- buff_test$buffers_proj
```


#### Saving the generated buffers
```{r}
saveRDS(df_buffers, "./data/df_ch_cdmx.rds")
saveRDS(proj_buffers, "./data/proj_buffers_cdmx.rds")
# df_buffers <-readRDS("./data/df_ch_df_test_15k_6km.rds")
# proj_buffers <- readRDS("./data/proj_buffers_test_15k_6km.rds")
```

#### Calculate convex hulls
```{r}
ch_df <- calc_convexhulls(df_buffers)
saveRDS(ch_df, "./data/df_ch_df_test_15k_6km.rds")
```

## Unions first attempt
```{r}
unions <- st_union(ch_df$ch_polygons) %>%  st_sf()
saveRDS(unions, "./data/df_unions_test_16k_6km.rds")
```
#### Big map with layers

###### Mocking data exercise - Restricting just to df schools
```{r}
source('utils.R')
library(tidygraph)
library(ggraph)
library(igraphdata)
# db <- readRDS("./data/master_db_filtered.rds")
# db <- db %>% mutate(estado=substr(cct,1,2)) %>% filter(estado=="09")
# db <- sample_n(db, 1000)
# db$latitud <- as.numeric(db$latitud)
# db$longitud <- as.numeric(db$longitud)
# # generating buffers
# buff_test <- calc_buffers(db, 3000)
# df_buffers <- buff_test$df_buffers
# proj_buffers <- buff_test$buffers_proj
df_buffers <- readRDS("./data/df_buffers_cdmx.rds")
proj_buffers <- readRDS("./data/proj_buffers_cdmx.rds")
# calculate convex hulls
ch_df <- calc_convexhulls(df_buffers)
# unions
unions <- st_union(ch_df$ch_polygons) %>%  st_sf()
```

```{r}
path <- "./data/agregados/"
df <- readRDS(paste0(path, "agregado_dist_sec_v2.rds"))
nodos <- df_buffers %>% rename(grupo=buffer, name=cct, lat=latitud, lon=longitud)
# nodos %>% group_by(grupo) %>%  summarise(n=n(), `.groups`="drop") %>% arrange(-n)
```

```{r}
selected_list <- comp_communities(buffer=1, nodos, df) 
select_nodos <- selected_list$selected_nodos
select_relations <- selected_list$select_relations
# elements for spatial network
sp_network <- compute_spatial_network(select_nodos, select_relations)
network <- sp_network$network
vert <- sp_network$verts
edges <- sp_network$edges
```

# Map in lealeft
```{r}
map_layers(vert, df_buffers, ch_df, unions, proj_buffers, edges, edges_type="flujo")
```



